<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ trộn câu hỏi trắc nghiệm</title>
    <!-- Tải Tailwind CSS để giao diện đẹp hơn -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện SheetJS (xlsx) để đọc và ghi file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tải thư viện JSZip để nén file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Thêm một vài style tùy chỉnh để giao diện thân thiện hơn */
        body {
            font-family: 'Inter', sans-serif;
        }

        .step-card {
            transition: all 0.3s ease-in-out;
        }

        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        table th,
        table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }

        tbody th {
            background-color: #f7fafc;
        }

        /* Style cho switch button */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2563eb;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Công cụ Trộn Câu Hỏi Trắc Nghiệm</h1>
            <p class="mt-2 text-lg text-gray-600">Tải file Excel, chọn sheet và tùy chỉnh để tạo bộ đề mới.</p>
        </header>

        <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg">

            <!-- Bước 1: Chọn File -->
            <div class="step-card border-l-4 border-blue-500 p-6 rounded-lg bg-gray-50 mb-6">
                <div class="flex items-center">
                    <div
                        class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl">
                        1</div>
                    <h2 class="text-2xl font-semibold ml-4">Chọn File Excel</h2>
                </div>
                <div class="mt-4 ml-14">
                    <input type="file" id="fileInput"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        accept=".xlsx, .xls">
                </div>
            </div>

            <!-- Bước 2: Chọn Sheet và Tùy chỉnh -->
            <div id="controlsContainer"
                class="step-card border-l-4 border-green-500 p-6 rounded-lg bg-gray-50 mb-6 hidden">
                <div class="flex items-center">
                    <div
                        class="bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl">
                        2</div>
                    <h2 class="text-2xl font-semibold ml-4">Chọn Sheet & Tùy chỉnh</h2>
                </div>
                <div class="space-y-6 mt-4 ml-14">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="sheetSelector" class="block mb-2 font-medium text-gray-700">Chọn sheet cần xử
                                lý:</label>
                            <select id="sheetSelector"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></select>
                        </div>
                        <div>
                            <label for="shuffleCountInput" class="block mb-2 font-medium text-gray-700">Số lần
                                trộn:</label>
                            <input type="number" id="shuffleCountInput" value="1" min="1"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                    <div class="flex items-center justify-start">
                        <input type="checkbox" id="shuffleAnswersCheckbox"
                            class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                        <label for="shuffleAnswersCheckbox" class="ml-3 text-base font-medium text-gray-700">Trộn thứ tự
                            các đáp án (C-H)?</label>
                    </div>
                    <!-- Tùy chọn chia nhỏ file -->
                    <div class="border-t pt-4">
                        <div class="flex items-center justify-between">
                            <label for="splitFilesSwitch" class="text-base font-medium text-gray-700">Chia nhỏ file kết
                                quả?</label>
                            <label class="switch">
                                <input type="checkbox" id="splitFilesSwitch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="splitOptions" class="hidden mt-4">
                            <label for="questionsPerFileInput" class="block mb-2 font-medium text-gray-700">Số câu hỏi
                                mỗi file:</label>
                            <input type="number" id="questionsPerFileInput" value="10" min="1"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                </div>
                <div class="mt-6 ml-14">
                    <button id="processButton"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled>
                        Bắt đầu trộn
                    </button>
                </div>
            </div>

            <!-- Vùng hiển thị kết quả và tải về -->
            <div id="outputContainer" class="hidden mt-8">
                <div class="step-card border-l-4 border-purple-500 p-6 rounded-lg bg-gray-50">
                    <div class="flex items-center">
                        <div
                            class="bg-purple-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl">
                            3</div>
                        <h2 class="text-2xl font-semibold ml-4">Kết Quả & Tải Về</h2>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button id="downloadButton"
                            class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            Tải File Excel Đã Trộn
                        </button>
                    </div>
                    <div class="mt-4 overflow-x-auto">
                        <p class="text-sm text-gray-500 mb-2">Xem trước 10 câu hỏi đầu tiên trong bộ đề đã trộn:</p>
                        <table id="resultTable" class="w-full text-sm border-collapse"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Khai báo các biến toàn cục
        let workbook = null;
        let processedData = [];

        // Lấy các element từ DOM
        const fileInput = document.getElementById('fileInput');
        const controlsContainer = document.getElementById('controlsContainer');
        const sheetSelector = document.getElementById('sheetSelector');
        const shuffleCountInput = document.getElementById('shuffleCountInput');
        const shuffleAnswersCheckbox = document.getElementById('shuffleAnswersCheckbox');
        const splitFilesSwitch = document.getElementById('splitFilesSwitch');
        const splitOptions = document.getElementById('splitOptions');
        const questionsPerFileInput = document.getElementById('questionsPerFileInput');
        const processButton = document.getElementById('processButton');
        const outputContainer = document.getElementById('outputContainer');
        const resultTable = document.getElementById('resultTable');
        const downloadButton = document.getElementById('downloadButton');

        // Xử lý sự kiện
        fileInput.addEventListener('change', handleFileSelect);
        sheetSelector.addEventListener('change', () => { processButton.disabled = !sheetSelector.value; });
        splitFilesSwitch.addEventListener('change', handleSplitToggle);
        processButton.addEventListener('click', processData);
        downloadButton.addEventListener('click', downloadResult);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, { type: 'array' });
                sheetSelector.innerHTML = '<option value="">-- Vui lòng chọn một sheet --</option>';
                workbook.SheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    sheetSelector.appendChild(option);
                });
                controlsContainer.classList.remove('hidden');
                outputContainer.classList.add('hidden');
                processButton.disabled = true;
            };
            reader.readAsArrayBuffer(file);
        }

        function handleSplitToggle() {
            if (splitFilesSwitch.checked) {
                splitOptions.classList.remove('hidden');
                downloadButton.textContent = 'Tải File ZIP Đã Nén';
            } else {
                splitOptions.classList.add('hidden');
                downloadButton.textContent = 'Tải File Excel Đã Trộn';
            }
        }

        function processData() {
            const sheetName = sheetSelector.value;
            if (!sheetName) { alert('Vui lòng chọn một sheet để xử lý.'); return; }

            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (data.length < 2) { alert('Sheet được chọn không có đủ dữ liệu.'); return; }

            const header = data[0];
            let questions = data.slice(1).filter(row => row && row[1] && row[1].toString().trim() !== '');

            if (questions.length === 0) { alert('Không tìm thấy câu hỏi nào hợp lệ.'); return; }

            const shuffleCount = parseInt(shuffleCountInput.value, 10) || 1;
            for (let i = 0; i < shuffleCount; i++) {
                shuffleArray(questions);
            }

            if (shuffleAnswersCheckbox.checked) {
                shuffleAnswersAndUpdateCorrect(questions);
            }

            questions.forEach((questionRow, index) => { questionRow[0] = index + 1; });

            processedData = [header, ...questions];
            displayPreview(processedData);
            outputContainer.classList.remove('hidden');
        }

        function shuffleAnswersAndUpdateCorrect(questions) {
            questions.forEach(questionRow => {
                const correctAnswerLetter = (questionRow[8] || '').toString().trim().toUpperCase();
                if (!correctAnswerLetter) return;
                const originalCorrectAnswerIndex = correctAnswerLetter.charCodeAt(0) - 'A'.charCodeAt(0);
                if (originalCorrectAnswerIndex < 0 || originalCorrectAnswerIndex > 5) return;
                const correctAnswerText = questionRow[originalCorrectAnswerIndex + 2];
                if (correctAnswerText === undefined || correctAnswerText === null) return;
                const answersPart = questionRow.slice(2, 8);
                const existingAnswers = answersPart.filter(ans => ans != null && ans.toString().trim() !== '');
                shuffleArray(existingAnswers);
                const newCorrectAnswerIndex = existingAnswers.findIndex(ans => ans === correctAnswerText);
                if (newCorrectAnswerIndex !== -1) {
                    questionRow[8] = String.fromCharCode('A'.charCodeAt(0) + newCorrectAnswerIndex);
                }
                for (let j = 0; j < 6; j++) {
                    questionRow[j + 2] = j < existingAnswers.length ? existingAnswers[j] : '';
                }
            });
        }

        async function downloadResult() {
            if (splitFilesSwitch.checked) {
                // Tải về dưới dạng ZIP
                const questionsPerFile = parseInt(questionsPerFileInput.value, 10) || 10;
                const header = processedData[0];
                const questions = processedData.slice(1);
                const zip = new JSZip();

                for (let i = 0; i < questions.length; i += questionsPerFile) {
                    const chunk = questions.slice(i, i + questionsPerFile);
                    const chunkData = [header, ...chunk];
                    const newWorksheet = XLSX.utils.aoa_to_sheet(chunkData);
                    const newWorkbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, `DeThi_Phan_${i / questionsPerFile + 1}`);
                    const xlsxData = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
                    zip.file(`BoDe_Phan_${i / questionsPerFile + 1}.xlsx`, xlsxData);
                }

                const zipBlob = await zip.generateAsync({ type: "blob" });
                triggerDownload(zipBlob, 'CacBoDeThi.zip');

            } else {
                // Tải về 1 file Excel như cũ
                const newWorksheet = XLSX.utils.aoa_to_sheet(processedData);
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'BoDeDaTron');
                XLSX.writeFile(newWorkbook, 'BoCauHoi_DaTron.xlsx');
            }
        }

        function triggerDownload(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function displayPreview(data) {
            resultTable.innerHTML = '';
            const header = data[0];
            const previewData = data.slice(1, 11);
            const thead = document.createElement('thead');
            thead.className = "bg-gray-200 text-gray-700";
            const headerRow = document.createElement('tr');
            const emptyTh = document.createElement('th');
            emptyTh.className = "p-3 font-semibold tracking-wide";
            headerRow.appendChild(emptyTh);
            header.slice(1).forEach(text => {
                const th = document.createElement('th');
                th.className = "p-3 font-semibold tracking-wide";
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            resultTable.appendChild(thead);
            const tbody = document.createElement('tbody');
            tbody.className = "divide-y divide-gray-200";
            previewData.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.className = "bg-white hover:bg-gray-50";
                rowData.forEach((cellData, index) => {
                    const cell = index === 0 ? document.createElement('th') : document.createElement('td');
                    cell.className = index === 0 ? "p-3 font-semibold" : "p-3 text-gray-700 whitespace-nowrap";
                    if (index === 0) cell.scope = "row";
                    cell.textContent = cellData;
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
            resultTable.appendChild(tbody);
        }
    </script>
</body>

</html>